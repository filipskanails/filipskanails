<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Дякуємо — Next Level</title>
  <meta name="color-scheme" content="dark">
  <style>
    :root{
      --bg:#0c100e; --card:#121614; --line:#223129;
      --text:#e7f0ea; --muted:#a1b3ab;
      --accent:#004a25; --accent-2:#0b7d47; --accent-rgb:0,74,37;
      --ok:#c7f5d2; --wait:#ffe3a3; --err:#ffb4b4;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:radial-gradient(1200px 600px at 20% -10%,rgba(var(--accent-rgb),.25),transparent 60%),var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:28px 16px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),transparent),var(--card);border:1px solid var(--line);border-radius:20px;padding:18px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.02),0 10px 26px rgba(0,0,0,.22)}
    h1{font-size:28px;margin:0 0 8px;letter-spacing:.2px}
    h2{font-size:20px;margin:16px 0 8px}
    .muted{color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:700}
    .badge.ok{background:rgba(34,197,94,.15);color:var(--ok);border:1px solid rgba(34,197,94,.3)}
    .badge.wait{background:rgba(234,179,8,.10);color:var(--wait);border:1px solid rgba(234,179,8,.28)}
    .badge.err{background:rgba(239,68,68,.10);color:var(--err);border:1px solid rgba(239,68,68,.28)}
    .cta{display:inline-flex;align-items:center;justify-content:center;padding:14px 20px;border-radius:999px;background:linear-gradient(135deg,var(--accent-2),var(--accent));color:#062217;font-weight:900;text-transform:uppercase;box-shadow:0 10px 28px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.12);text-decoration:none;border:0;cursor:pointer}
    .cta:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row .cta{flex:1;min-width:220px}
    .btn-secondary{background:#0f1713;color:var(--text);border:1px solid #2b4136;text-transform:none;font-weight:700}
    .btn-ghost{background:transparent;border:1px dashed #2b4136;color:var(--muted);text-transform:none}
    .steps{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
    @media (max-width:700px){ .steps{grid-template-columns:1fr} }
    .step{border:1px solid var(--line);border-radius:14px;padding:14px;background:rgba(255,255,255,.02);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .chip{min-width:64px;text-align:center;border-radius:8px;padding:6px 8px;font-weight:800;color:#062217;background:linear-gradient(135deg,var(--accent-2),var(--accent))}
    .note{font-size:14px;color:var(--muted);margin-top:8px}
    .kbd{padding:2px 8px;border-radius:6px;background:#0f1713;border:1px solid #27382f}
    .box{padding:12px;border:1px dashed var(--line);border-radius:14px;background:rgba(255,255,255,.02)}
    .debug{margin-top:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;white-space:pre-wrap;background:#0b120f;border:1px solid #23352c;border-radius:12px;padding:10px;color:#b6c9c0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Дякуємо за оплату <span id="statusBadge" class="badge wait">Очікуємо оплату…</span></h1>
      <p class="muted">Замовлення: <b id="ref">—</b> • Провайдер: <b id="prov">—</b></p>
      <p class="muted">Статус: <b id="status">очікується</b></p>

      <div class="steps">
        <div class="step"><div><b>1. Рахунок</b><br><span class="muted">Відкрийте сторінку платежу</span></div><div class="chip">Link</div></div>
        <div class="step"><div><b>2. Оплатити в банку</b><br><span class="muted">Підтвердіть платіж у застосунку</span></div><div class="chip">App</div></div>
        <div class="step"><div><b>3. Повернутись сюди</b><br><span class="muted">Статус оновиться автоматично</span></div><div class="chip">Auto</div></div>
        <div class="step"><div><b>4. Продовжити в боті</b><br><span class="muted">Отримаєте доступ до уроків</span></div><div class="chip">Telegram</div></div>
      </div>

      <div class="box" style="margin-top:12px">
        <h2>Дії</h2>
        <div id="actions" class="row" style="margin-top:10px">
          <a id="openPay" class="cta" target="_blank" rel="noopener">Відкрити оплату</a>
          <button id="checkNow" class="cta btn-secondary">Перевірити статус зараз</button>
          <button id="paidBtn" class="cta btn-ghost">Я оплатив(ла)</button>
        </div>
        <p class="note" id="helpText">Якщо випадково закрили вкладку з оплатою — натисніть «Відкрити оплату» ще раз. Якщо оплата не проходить — спробуйте іншу картку або зв’яжіться з нами.</p>
      </div>

      <div id="afterSuccess" style="display:none; margin-top:16px">
        <h2>Оплата успішна ✅</h2>
        <p class="muted" id="nextSteps">
          Перейдіть у наш Telegram-бот, щоб отримати доступ до відео-уроків<span id="planHint"></span>.
          Якщо у вас індивідуальний тариф — надсилайте ДЗ прямо в боті.
        </p>
        <div class="row" style="margin-top:10px" id="tgButtons"></div>
        <p class="note">Якщо кнопка не відкриває застосунок — скористайтесь посиланням у браузері: <span id="botLinkEcho" class="kbd"></span></p>
        <div class="row" style="margin-top:10px">
          <a id="toHome" class="cta btn-secondary" href="#">Повернутись на сайт</a>
        </div>
      </div>

      <div id="debug" class="debug" style="display:none"></div>
    </div>
  </div>

  <script>
  (function(){
    const $ = s => document.querySelector(s);

    // ==== КОНФІГ ====
    const BOT_HANDLE = "NailSchoolFilipskabot";
    // ВАЖЛИВО: використовуємо абсолютний URL воркера
    const WORKER = "https://filipskanails-pay.timanov-business.workers.dev";
    const DEBUG_ON = true; // ← вимкни на проді, якщо не треба

    // ==== ПАРСИНГ ПАРАМЕТРІВ ====
    const params    = new URLSearchParams(location.search);
    const ref       = params.get('ref') || "";
    const invoiceId = params.get('invoiceId') || "";
    const pay       = params.get('pay') || "";
    const plan      = (params.get('plan') || "").toLowerCase(); // "group" | "individual"
    const homeParam = params.get('home') || "";

    $('#ref').textContent = ref || '—';

    function dlog(obj){
      if(!DEBUG_ON) return;
      const el = $('#debug');
      el.style.display = 'block';
      try{ el.textContent = JSON.stringify(obj, null, 2); }catch{ el.textContent = String(obj); }
    }

    // Нормалізація HOME
    function normalizeHome(h){
      try{ const u=new URL(h); return u.origin + u.pathname.replace(/\/?$/, '/'); }catch{ return null; }
    }
    const ALLOWED = new Set([
      "https://filipskanails.github.io/filipskanails/",
      "https://filipskanails.github.io/filipska-nails/",
    ]);
    let HOME = normalizeHome(homeParam);
    if(!HOME || !ALLOWED.has(HOME)){
      HOME = location.origin + location.pathname.replace(/thankyou\.html.*$/,'');
    }

    // Кнопка оплати (універсально)
    if (pay) $('#openPay').href = pay;
    else $('#openPay').style.display = 'none';

    // Підказка за тарифом
    const hint = (plan === 'individual') ? ' (та надсилати ДЗ)' : '';
    $('#planHint').textContent = hint;

    // Статус бейдж
    function setStatus(txt, cls){
      $('#status').textContent = txt;
      const badge = $('#statusBadge');
      badge.textContent = (cls==='ok') ? 'Оплачено' : (cls==='err') ? 'Помилка' : 'Очікуємо оплату…';
      badge.className = 'badge ' + cls;
    }

    // Telegram-кнопка
    function renderTelegramButton(){
      const wrap = $('#tgButtons');
      wrap.innerHTML = '';
      if (!BOT_HANDLE || !ref) {
        const p = document.createElement('p');
        p.className = 'muted';
        p.textContent = 'Посилання на бота тимчасово недоступне.';
        wrap.appendChild(p);
        return;
      }
      const botHref = `https://t.me/${BOT_HANDLE}?start=${encodeURIComponent(ref)}`;
      const a = document.createElement('a');
      a.className = 'cta';
      a.textContent = 'Продовжити в Telegram-боті';
      a.href = botHref;
      a.target = '_blank';
      a.rel = 'noopener';
      wrap.appendChild(a);
      $('#botLinkEcho').textContent = botHref;
    }

    // Універсальний fetch JSON (із дебагом)
    async function getJSON(url){
      try{
        const r = await fetch(url, { method:'GET', mode:'cors', cache:'no-store' });
        const txt = await r.text();
        try{
          const j = JSON.parse(txt);
          return { ok:true, data:j, status:r.status, raw:txt };
        }catch{
          return { ok:false, error:'bad json', status:r.status, raw:txt, url };
        }
      }catch(e){
        return { ok:false, error:String(e), url };
      }
    }

    async function checkByRef(){
      if(!ref) return { ok:false, error:'missing ref' };
      const url = `${WORKER.replace(/\/+$/,'')}/pay/status?ref=${encodeURIComponent(ref)}&_ts=${Date.now()}`;
      const res = await getJSON(url);
      return res;
    }
    async function checkByInvoice(){
      if(!invoiceId) return { ok:false, error:'missing invoiceId' };
      const url = `${WORKER.replace(/\/+$/,'')}/pay/status?invoiceId=${encodeURIComponent(invoiceId)}&_ts=${Date.now()}`;
      const res = await getJSON(url);
      return res;
    }

    // Основна логіка опитування
    let pollTimer = null;
    async function checkStatus(){
      clearTimeout(pollTimer);
      // 1) спроба по ref
      let res = await checkByRef();

      // якщо по ref щось пішло не так — пробуємо по invoiceId
      if(!res.ok || (res.ok && res.data && res.data.status === 'error')){
        const fallback = await checkByInvoice();
        // якщо fallback кращий — беремо його
        if (fallback.ok) res = fallback;
      }

      // дебаг-вивід
      dlog({
        tryRef: true,
        url: res.url || '(see raw)',
        responseStatus: res.status,
        ok: res.ok,
        data: res.data || null,
        error: res.error || null,
        raw: res.raw && res.raw.slice ? res.raw.slice(0, 500) : undefined
      });

      if(!res.ok){
        setStatus('тимчасова помилка мережі', 'wait');
        schedule();
        return;
      }

      const d = res.data || {};
      $('#prov').textContent = d.provider || '—';

      const st = String(d.status || '').toLowerCase();
      if(st === 'paid' || st === 'success'){
        setStatus('успішно', 'ok');
        $('#actions').style.display = 'none';
        $('#afterSuccess').style.display = 'block';
        renderTelegramButton();
        return;
      }
      if(st === 'failed' || st === 'failure' || st === 'expired' || st === 'reversed'){
        setStatus('помилка', 'err');
        return;
      }

      setStatus(st || 'очікується', 'wait');
      schedule();
    }
    function schedule(){ clearTimeout(pollTimer); pollTimer = setTimeout(checkStatus, 5000); }

    // Обработчики
    $('#checkNow').addEventListener('click', (e)=>{ e.preventDefault(); checkStatus(); });
    $('#paidBtn').addEventListener('click', (e)=>{ e.preventDefault(); checkStatus(); });
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) checkStatus(); });
    $('#toHome').addEventListener('click', (e)=>{ e.preventDefault(); location.href = HOME + '#top'; });

    // Старт
    checkStatus();
  })();
  </script>
</body>
</html>