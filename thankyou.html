<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Дякуємо — Next Level</title>
  <meta name="color-scheme" content="dark">
  <style>
    :root{
      --bg:#0c100e; --card:#101411; --line:#233129;
      --text:#e7f0ea; --muted:#9fb3aa;
      --accent:#0b7d47; --accent-2:#004a25; --accent-rgb:11,125,71;
      --ok:#c7f5d2; --wait:#ffe3a3; --err:#ffb4b4;
      --ring: 0 0 0 4px rgba(11,125,71,.25);
    }
    *{box-sizing:border-box}
    html,body{
      margin:0; color:var(--text); background:
        radial-gradient(1200px 700px at 10% -10%, rgba(var(--accent-rgb),.22), transparent 50%),
        radial-gradient(900px 600px at 95% 10%, rgba(0,0,0,.22), transparent 50%),
        var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,sans-serif;
    }
    .wrap{max-width:960px;margin:0 auto;padding:32px 16px}
    .card{
      position:relative;
      background:linear-gradient(180deg, rgba(255,255,255,.035), transparent 60%), var(--card);
      border:1px solid var(--line); border-radius:20px; padding:22px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02), 0 12px 28px rgba(0,0,0,.28);
    }
    h1{margin:0 0 8px;font-size:30px;letter-spacing:.2px}
    h2{font-size:20px;margin:16px 0 8px}
    .muted{color:var(--muted)}

    /* badges */
    .badges{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 0}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:7px 12px;border-radius:999px;font-weight:800}
    .badge.ok   {background:rgba(34,197,94,.12); color:var(--ok);  border:1px solid rgba(34,197,94,.35)}
    .badge.err  {background:rgba(239,68,68,.10); color:var(--err); border:1px solid rgba(239,68,68,.32)}
    .badge.wait {background:rgba(234,179,8,.08); color:var(--wait);border:1px solid rgba(234,179,8,.30)}
    .badge.plan {background:rgba(11,125,71,.12); color:#8BE0B4; border:1px solid rgba(11,125,71,.35)}
    .pulse{animation:pulse 1.4s ease-in-out infinite}
    @keyframes pulse { 0%,100%{ transform:translateZ(0) scale(1); } 50%{ transform:translateZ(0) scale(1.04); } }

    /* progress steps */
    .progress{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:14px 0 6px}
    .step{
      padding:14px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.02); position:relative; overflow:hidden;
    }
    .step::after{
      content:""; position:absolute; inset:auto -40% -60% -40%; height:110px;
      background: radial-gradient(90px 40px at 50% 0, rgba(255,255,255,.04), transparent 60%);
      transform:rotate(-8deg);
    }
    .s-title{font-weight:800}
    .s-hint{color:var(--muted);font-size:13px;margin-top:4px}
    .chip{display:inline-block;margin-left:auto; float:right; padding:6px 8px; border-radius:8px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#061f15; font-weight:900; font-size:12px}

    @media (max-width:800px){
      .progress{grid-template-columns:1fr 1fr}
    }
    @media (max-width:520px){
      .progress{grid-template-columns:1fr}
      .chip{float:none;margin-top:6px}
    }

    /* buttons */
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .cta{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:14px 20px;border-radius:999px;border:0; cursor:pointer;
      background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#052116;
      font-weight:900; text-transform:uppercase; text-decoration:none;
      box-shadow: 0 10px 28px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.12);
      transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
    }
    .cta:hover{ transform: translateY(-1px); box-shadow: 0 12px 30px rgba(0,0,0,.33), var(--ring) }
    .cta:active{ transform: translateY(0) scale(.98) }
    .cta:disabled{ opacity:.6; cursor:not-allowed; filter:grayscale(.3) }
    .btn-secondary{
      background:#0f1713; color:var(--text); border:1px solid #2b4136; text-transform:none; font-weight:800;
    }
    .btn-ghost{
      background:transparent; color:var(--muted);
      border:1px dashed #2b4136; text-transform:none; font-weight:800;
    }

    .box{padding:14px;border:1px dashed var(--line);border-radius:14px;background:rgba(255,255,255,.02)}
    .note{font-size:14px;color:var(--muted);margin-top:8px}

    /* compact alt-open block */
    .alt-open{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .mini{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid #2b4136;background:#0f1713;color:var(--text);text-decoration:none;font-weight:700}
    .kbd{padding:6px 8px;border-radius:8px;background:#0f1713;border:1px solid #27382f;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
    .copy{cursor:pointer}

    /* confetti canvas */
    #fx{position:fixed; inset:0; pointer-events:none}
    @media (prefers-reduced-motion: reduce){
      .pulse{animation:none}
      .cta{transition:none}
    }
  </style>
</head>
<body>
  <canvas id="fx"></canvas>
  <div class="wrap">
    <div class="card">
      <h1>Дякуємо за замовлення</h1>
      <div class="badges">
        <span id="statusBadge" class="badge wait pulse">Очікуємо оплату…</span>
        <span id="planBadge" class="badge plan" title="Обраний тариф">Тариф: —</span>
      </div>

      <p class="muted" style="margin-top:10px">Замовлення: <b id="ref">—</b> • Провайдер: <b id="prov">—</b></p>
      <p class="muted">Статус: <b id="status">очікується</b></p>

      <div class="progress">
        <div class="step"><span class="s-title">Рахунок</span> <span class="chip">Link</span><div class="s-hint">Відкрийте сторінку платежу</div></div>
        <div class="step"><span class="s-title">Оплата в банку</span> <span class="chip">App</span><div class="s-hint">Підтвердіть платіж у застосунку</div></div>
        <div class="step"><span class="s-title">Повернутись сюди</span> <span class="chip">Auto</span><div class="s-hint">Статус оновиться автоматично</div></div>
        <div class="step"><span class="s-title">Продовжити в боті</span> <span class="chip">Telegram</span><div class="s-hint">Отримаєте доступ до уроків</div></div>
      </div>

      <div class="box" style="margin-top:10px">
        <h2>Дії</h2>
        <div id="actions" class="row" style="margin-top:10px">
          <a id="openPay" class="cta" target="_blank" rel="noopener">Відкрити оплату</a>
          <button id="checkNow" class="cta btn-secondary">Перевірити статус</button>
          <button id="paidBtn" class="cta btn-ghost">Я оплатив(ла)</button>
        </div>
        <p class="note" id="helpText">
          Якщо випадково закрили вкладку з оплатою — натисніть «Відкрити оплату» ще раз. Якщо оплата не проходить — спробуйте іншу картку або зв’яжіться з нами.
        </p>
      </div>

      <div id="afterSuccess" style="display:none; margin-top:16px">
        <h2>Оплата успішна ✅</h2>
        <p class="muted" id="nextSteps">
          Ваш план: <b id="planText">—</b>. Перейдіть у наш Telegram-бот, щоб отримати доступ до відео-уроків.
        </p>

        <div class="row" style="margin-top:10px" id="tgButtons"></div>

        <!-- красивий компактний блок замість “некрасивого” речення -->
        <div class="alt-open" id="altOpen" style="display:none;">
          <a id="botOpenWeb" class="mini" target="_blank" rel="noopener">Відкрити у браузері</a>
          <span class="kbd" id="botLinkEcho"></span>
          <button class="mini copy" id="copyBtn" type="button">Скопіювати</button>
          <span class="note">Якщо кнопка застосунку не спрацьовує — скористайтесь одним із варіантів вище.</span>
        </div>

        <div class="row" style="margin-top:14px">
          <a id="toHome" class="cta btn-secondary" href="#">Повернутись на сайт</a>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const $ = s => document.querySelector(s);

    /* ==== КОНФІГ ==== */
    const BOT_HANDLE = "NailSchoolFilipskabot";
    const WORKER = "https://filipskanails-pay.timanov-business.workers.dev";

    /* ==== ПАРАМЕТРИ ==== */
    const params    = new URLSearchParams(location.search);
    const ref       = params.get('ref') || "";
    const invoiceId = params.get('invoiceId') || "";
    const pay       = params.get('pay') || "";
    const planParam = (params.get('plan') || "").toLowerCase(); // "group" | "individual"
    const homeParam = params.get('home') || "";
    $('#ref').textContent = ref || '—';

    // Визначаємо план: з param або з префікса ref
    function derivePlan(){
      if (planParam === 'group' || planParam === 'individual') return planParam;
      if (/^NL-I/i.test(ref)) return 'individual';
      if (/^NL-G/i.test(ref)) return 'group';
      return '';
    }
    function planLabel(p){
      if (p === 'individual') return 'Індивідуальний';
      if (p === 'group') return 'Груповий';
      return '—';
    }
    const plan = derivePlan();
    $('#planBadge').textContent = 'Тариф: ' + planLabel(plan);

    function normalizeHome(h){
      try{ const u=new URL(h); return u.origin + u.pathname.replace(/\/?$/, '/'); }catch{ return null; }
    }
    const ALLOWED = new Set([
      "https://filipskanails.github.io/filipskanails/",
      "https://filipskanails.github.io/filipska-nails/",
    ]);
    let HOME = normalizeHome(homeParam);
    if(!HOME || !ALLOWED.has(HOME)){
      HOME = location.origin + location.pathname.replace(/thankyou\.html.*$/,'');
    }

    // Кнопка оплати
    if (pay) $('#openPay').href = pay;
    else $('#openPay').style.display = 'none';

    // UI статус
    function setStatus(txt, cls){
      $('#status').textContent = txt;
      const badge = $('#statusBadge');
      badge.textContent = (cls==='ok') ? 'Оплачено' : (cls==='err') ? 'Помилка' : 'Очікуємо оплату…';
      badge.className = 'badge ' + (cls || 'wait') + (cls==='wait' ? ' pulse' : '');
    }

    // Телеграм кнопки + альтернативи
    function renderTelegramSection(){
      const wrap = $('#tgButtons'); wrap.innerHTML = '';
      if (!BOT_HANDLE || !ref) {
        const p = document.createElement('p');
        p.className = 'muted';
        p.textContent = 'Посилання на бота тимчасово недоступне.';
        wrap.appendChild(p);
        return;
      }
      const botHref = `https://t.me/${BOT_HANDLE}?start=${encodeURIComponent(ref)}`;

      const a = document.createElement('a');
      a.className = 'cta';
      a.textContent = 'Продовжити в Telegram-боті';
      a.href = botHref; a.target = '_blank'; a.rel = 'noopener';
      wrap.appendChild(a);

      // Альтернативи: відобразити компактний блок з копією/відкриттям у браузері
      $('#botLinkEcho').textContent = botHref;
      $('#botOpenWeb').href = botHref;
      $('#altOpen').style.display = 'flex';
      $('#copyBtn').onclick = async () => {
        try{
          await navigator.clipboard.writeText(botHref);
          const b = $('#copyBtn'); const prev = b.textContent;
          b.textContent = 'Скопійовано ✓';
          setTimeout(()=> b.textContent = prev, 1500);
        }catch{}
      };

      // Текст плану в Success-блоці
      $('#planText').textContent = planLabel(plan);
    }

    // fetch JSON із страховкою
    async function getJSON(url){
      const r = await fetch(url, { method:'GET', mode:'cors', cache:'no-store' });
      const txt = await r.text();
      try{ return JSON.parse(txt); }catch{ return { status:'error', error:'bad json', raw:txt }; }
    }
    async function checkByRef(){
      if(!ref) return { status:'error', error:'missing ref' };
      const url = `${WORKER.replace(/\/+$/,'')}/pay/status?ref=${encodeURIComponent(ref)}&_t=${Date.now()}`;
      return getJSON(url);
    }
    async function checkByInvoice(){
      if(!invoiceId) return { status:'error', error:'missing invoiceId' };
      const url = `${WORKER.replace(/\/+$/,'')}/pay/status?invoiceId=${encodeURIComponent(invoiceId)}&_t=${Date.now()}`;
      return getJSON(url);
    }

    // Конфетті (легка версія)
    const fx = document.getElementById('fx');
    const ctx = fx.getContext('2d');
    let confetti = [];
    function resize(){ fx.width = innerWidth; fx.height = innerHeight; }
    addEventListener('resize', resize); resize();
    function spawnConfetti(n=150){
      confetti = Array.from({length:n}, ()=>({
        x: Math.random()*fx.width, y: -10 - Math.random()*fx.height*0.3,
        s: 2+Math.random()*4, a: Math.random()*Math.PI*2,
        v: 1+Math.random()*2, w: (Math.random()-.5)*0.08,
        c: Math.random()<.5 ? '#8BE0B4' : '#68C49A'
      }));
      let t0=null;
      function step(ts){
        if(!t0) t0=ts;
        const dt=(ts-t0)/16; t0=ts;
        ctx.clearRect(0,0,fx.width,fx.height);
        confetti.forEach(p=>{
          p.y+=p.v*dt; p.a+=p.w*dt;
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a);
          ctx.fillStyle=p.c; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s*2);
          ctx.restore();
        });
        confetti = confetti.filter(p=>p.y<fx.height+20);
        if(confetti.length) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
      setTimeout(()=>{ ctx.clearRect(0,0,fx.width,fx.height); confetti=[]; }, 4000);
    }

    // Поллінг статусу
    let pollTimer=null;
    async function checkStatus(){
      clearTimeout(pollTimer);
      let data = await checkByRef();
      if(data?.status==='error'){ // fallback
        const fb = await checkByInvoice();
        if(fb && fb.status && fb.status!=='error') data = fb;
      }

      $('#prov').textContent = data?.provider || '—';

      const st = String(data?.status || '').toLowerCase();
      if(st === 'paid' || st === 'success'){
        setStatus('успішно', 'ok');
        $('#actions').style.display = 'none';
        $('#afterSuccess').style.display = 'block';
        renderTelegramSection();
        spawnConfetti();
        return;
      }
      if(st === 'failed' || st === 'failure' || st === 'expired' || st === 'reversed'){
        setStatus('помилка', 'err');
        return;
      }
      setStatus(st === 'error' ? 'тимчасова помилка мережі' : (st || 'очікується'), 'wait');
      schedule();
    }
    function schedule(){ clearTimeout(pollTimer); pollTimer = setTimeout(checkStatus, 5000); }

    // Події
    $('#checkNow').addEventListener('click', (e)=>{ e.preventDefault(); checkStatus(); });
    $('#paidBtn').addEventListener('click', (e)=>{ e.preventDefault(); checkStatus(); });
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) checkStatus(); });
    $('#toHome').addEventListener('click', (e)=>{ e.preventDefault(); location.href = HOME + '#top'; });

    // HOME нормалізація
    function normalizeHome(h){
      try{ const u=new URL(h); return u.origin + u.pathname.replace(/\/?$/, '/'); }catch{ return null; }
    }
    const ALLOWED = new Set([
      "https://filipskanails.github.io/filipskanails/",
      "https://filipskanails.github.io/filipska-nails/",
    ]);
    let HOME = normalizeHome(new URLSearchParams(location.search).get('home')||"");
    if(!HOME || !ALLOWED.has(HOME)){
      HOME = location.origin + location.pathname.replace(/thankyou\.html.*$/,'');
    }

    // Старт
    checkStatus();
  })();
  </script>
</body>
</html>